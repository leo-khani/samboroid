[gd_scene format=3 uid="uid://lqaxhqq5yg8k"]

[ext_resource type="Script" uid="uid://cqukcnlad70er" path="res://scenes/Objects/Planet/planet.gd" id="1_aeeex"]
[ext_resource type="Script" uid="uid://cg3h6e3n3kyv" path="res://scripts/PlanetStats.gd" id="2_6ltg3"]
[ext_resource type="Texture2D" uid="uid://dfhnr1xebf4tf" path="res://assets/Planets/rocky_01.png" id="3_6ltg3"]
[ext_resource type="Shader" uid="uid://ckli6f8thxu8o" path="res://shaders/outliner.gdshader" id="3_md8uk"]

[sub_resource type="Resource" id="Resource_md8uk"]
script = ExtResource("2_6ltg3")
metadata/_custom_type_script = "uid://cg3h6e3n3kyv"

[sub_resource type="Shader" id="Shader_ravj5"]
resource_local_to_scene = true
code = "shader_type canvas_item;

// ─────────────────────────────────────────
//  PLANET GRAVITY INDICATOR — 2D
//  Godot 4.x  |  canvas_item shader
// ─────────────────────────────────────────

// --- Core ---
uniform float gravity_strength : hint_range(0.0, 1.0) = 0.7;
uniform float inner_radius : hint_range(0.0, 0.5) = 0.18;   // planet body edge (UV space)
uniform float outer_radius : hint_range(0.0, 0.5) = 0.48;   // field boundary (UV space)

// --- Colors ---
uniform vec4 core_color    : source_color = vec4(0.3,  0.85, 1.0,  1.0);
uniform vec4 field_color   : source_color = vec4(0.05, 0.25, 0.7,  1.0);
uniform vec4 ring_color    : source_color = vec4(1.0,  0.92, 0.35, 1.0);
uniform vec4 outer_color   : source_color = vec4(0.0,  0.1,  0.4,  0.0);

// --- Rings ---
uniform int   ring_count       : hint_range(1, 6) = 4;
uniform float ring_speed       : hint_range(0.1, 4.0) = 1.1;
uniform float ring_width       : hint_range(0.002, 0.06) = 0.018;
uniform float ring_spacing     : hint_range(0.05, 0.35) = 0.22;  // gap between rings

// --- Juice ---
uniform float breath_speed  : hint_range(0.1, 3.0) = 0.7;
uniform float breath_amount : hint_range(0.0, 0.15) = 0.045;
uniform float wobble_speed  : hint_range(0.0, 4.0) = 1.3;
uniform float wobble_amount : hint_range(0.0, 0.04) = 0.018;
uniform float shimmer_speed : hint_range(0.0, 6.0) = 2.5;
uniform float time_scale    : hint_range(0.1, 3.0) = 1.0;

// ── helpers ──────────────────────────────

float hash(vec2 p) {
	return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453);
}

float noise(vec2 p) {
	vec2 i = floor(p);
	vec2 f = fract(p);
	f = f * f * (3.0 - 2.0 * f);
	return mix(
		mix(hash(i),              hash(i + vec2(1,0)), f.x),
		mix(hash(i + vec2(0,1)),  hash(i + vec2(1,1)), f.x),
		f.y);
}

// Signed distance to a circle edge
float ring_sdf(float d, float r) {
	return abs(d - r);
}

void fragment() {
	float t = TIME * time_scale;

	// UV centred at (0,0), range roughly ±0.5
	vec2 uv = UV - 0.5;

	// ── Organic wobble ───────────────────────────────────
	// Distort UV slightly using angle-dependent noise so
	// rings look like energy fields, not perfect circles.
	float angle = atan(uv.y, uv.x);
	float wobble = noise(vec2(angle * 3.0 + t * wobble_speed,
	                          angle * 1.7 - t * wobble_speed * 0.6));
	wobble = (wobble - 0.5) * wobble_amount * gravity_strength;

	// Add a second harmonic for richer warping
	float wobble2 = noise(vec2(angle * 6.0 - t * wobble_speed * 1.4,
	                           t * 0.4)) * 0.5;
	wobble2 = (wobble2 - 0.5) * wobble_amount * 0.5 * gravity_strength;

	vec2 warped_uv = uv + normalize(uv + 0.0001) * (wobble + wobble2);
	float dist = length(warped_uv);   // distance from centre (warped)
	float dist_raw = length(uv);      // clean distance for masking

	// ── Breathing ────────────────────────────────────────
	float breath = 1.0 + sin(t * breath_speed) * breath_amount;
	float dist_b = dist * breath;     // breathing-scaled distance

	// ── Field mask  (donut between inner and outer radius) ─
	float field_t = smoothstep(inner_radius, inner_radius + 0.04, dist_raw)
	              * smoothstep(outer_radius, outer_radius - 0.04, dist_raw);
	field_t *= gravity_strength;

	// ── Base gradient — brighter near planet (gravity intensifies inward) ──
	float grad = 1.0 - smoothstep(inner_radius, outer_radius, dist_b);
	float grad_steep = pow(grad, 1.8);
	vec4 base_col = mix(outer_color, mix(field_color, core_color, grad_steep), grad_steep);

	// ── Inward rings (gravity pull: outer → inner) ────────
	float ring_alpha = 0.0;
	for (int i = 0; i < 6; i++) {
		if (i >= ring_count) break;

		float fi    = float(i);
		float phase = fract(t * ring_speed * 0.28 + fi / float(ring_count));

		// INWARD: ring starts at outer edge, travels toward planet
		float r = mix(outer_radius, inner_radius, phase);

		float d    = ring_sdf(dist_b, r);
		float ring = smoothstep(ring_width, 0.0, d);

		// Fade in as ring spawns at the outer edge, fade out as it
		// reaches the planet and gets \"swallowed\" — sin gives a natural arc
		float fade = sin(phase * 3.14159);

		// Bright wavefront head now on the INNER (leading) side of the ring
		// — it's being pulled, so the front glows brighter
		float head = smoothstep(ring_width * 2.0, 0.0, d) * phase * 0.6;

		ring_alpha += (ring + head) * fade * gravity_strength;
	}

	// ── Shimmer / static sparks ───────────────────────────
	float spark_uv_scale = 18.0;
	float spark = noise(warped_uv * spark_uv_scale + vec2(t * shimmer_speed, -t * shimmer_speed * 0.7));
	spark += noise(warped_uv * spark_uv_scale * 2.0 - vec2(t * shimmer_speed * 0.5, t));
	spark = pow(max(spark - 1.3, 0.0), 2.0);  // threshold + sharpen → sparse sparks
	spark *= field_t * 2.0;

	// ── Bright inner halo just outside planet body ────────
	float halo = smoothstep(inner_radius + 0.06, inner_radius, dist_b);
	halo *= smoothstep(inner_radius - 0.01, inner_radius + 0.02, dist_b);
	halo = pow(halo, 1.5) * gravity_strength;

	// ── Assemble ──────────────────────────────────────────
	vec4 col = base_col * field_t;
	col     += ring_color  * ring_alpha * field_t;
	col     += core_color  * spark;
	col     += core_color  * halo * 0.9;

	// Alpha: field + rings + halo
	float alpha = clamp(
		  grad_steep * field_t * 0.75
		+ ring_alpha * 0.95
		+ spark * 0.8
		+ halo * 0.85,
		0.0, 1.0);

	COLOR = vec4(col.rgb, alpha * gravity_strength);
}
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_ravj5"]
resource_local_to_scene = true
shader = SubResource("Shader_ravj5")
shader_parameter/gravity_strength = 0.50000002375
shader_parameter/inner_radius = 0.0870000041325
shader_parameter/outer_radius = 0.5
shader_parameter/core_color = Color(0.3, 0.85, 1, 1)
shader_parameter/field_color = Color(0.05, 0.25, 0.7, 1)
shader_parameter/ring_color = Color(1, 0.92, 0.35, 1)
shader_parameter/outer_color = Color(0, 0.1, 0.4, 0)
shader_parameter/ring_count = 4
shader_parameter/ring_speed = 0.30000001099011997
shader_parameter/ring_width = 0.018
shader_parameter/ring_spacing = 0.22
shader_parameter/breath_speed = 0.7
shader_parameter/breath_amount = 0.045
shader_parameter/wobble_speed = 1.3
shader_parameter/wobble_amount = 0.018
shader_parameter/shimmer_speed = 2.5
shader_parameter/time_scale = 1.0

[sub_resource type="CircleShape2D" id="CircleShape2D_fxu2j"]
resource_local_to_scene = true
radius = 49.99245

[sub_resource type="ShaderMaterial" id="ShaderMaterial_de54k"]
resource_local_to_scene = true
shader = ExtResource("3_md8uk")
shader_parameter/allow_out_of_bounds = true
shader_parameter/outline_thickness = 0.0
shader_parameter/outline_color = Color(1, 1, 1, 1)

[sub_resource type="CircleShape2D" id="CircleShape2D_ravj5"]
resource_local_to_scene = true
radius = 9.99849

[node name="Planet" type="StaticBody2D" unique_id=54183248 groups=["planets"]]
collision_mask = 0
script = ExtResource("1_aeeex")
stats = SubResource("Resource_md8uk")
hover_outline_thickness = 5.0

[node name="GravityField" type="ColorRect" parent="." unique_id=59771650]
material = SubResource("ShaderMaterial_ravj5")
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -49.99245
offset_top = -49.99245
offset_right = 49.99245
offset_bottom = 49.99245
grow_horizontal = 2
grow_vertical = 2
pivot_offset_ratio = Vector2(0.5, 0.5)
mouse_filter = 2
metadata/_edit_use_anchors_ = true

[node name="CollisionShape2D" type="CollisionShape2D" parent="." unique_id=1348646464]
visible = false
shape = SubResource("CircleShape2D_fxu2j")

[node name="Sprite2D" type="Sprite2D" parent="." unique_id=1575841339]
material = SubResource("ShaderMaterial_de54k")
rotation = 6.2831855
scale = Vector2(0.1999698, 0.1999698)
texture = ExtResource("3_6ltg3")

[node name="SelectionArea" type="Area2D" parent="." unique_id=805164557]

[node name="SelectionAreaCollisionShape2D" type="CollisionShape2D" parent="SelectionArea" unique_id=1403134712]
shape = SubResource("CircleShape2D_ravj5")
debug_color = Color(0.6263142, 0.52700806, 0.20440516, 0.41960785)

[connection signal="body_entered" from="SelectionArea" to="." method="_on_selection_area_body_entered"]
[connection signal="body_exited" from="SelectionArea" to="." method="_on_selection_area_body_exited"]
[connection signal="mouse_entered" from="SelectionArea" to="." method="_on_selection_area_mouse_entered"]
[connection signal="mouse_exited" from="SelectionArea" to="." method="_on_selection_area_mouse_exited"]
